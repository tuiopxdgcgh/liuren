<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å…­å£¬æ™ºèƒ½æ’ç›˜ç³»ç»Ÿ - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.13.2/lunar.js"></script>
    <style>
        :root {
            --primary-color: #8E44AD;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-color: #333;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        input[type="datetime-local"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }
        button:hover { background-color: #732d91; }
        button.secondary { background-color: #2c3e50; }

        .pan-section { margin-bottom: 25px; }
        .section-title {
            font-weight: bold;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 15px;
            background: #f4eff7;
            padding: 5px 10px;
            border-radius: 0 5px 5px 0;
        }

        /* åŸºç¡€ä¿¡æ¯ */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
            background: #fcfcfc;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 0.95em;
        }

        /* ä¸‰ä¼  */
        .sanchuan-box {
            display: flex;
            justify-content: space-around;
            text-align: center;
            background: #fffbfb;
            padding: 15px;
            border: 1px solid #ffe0e0;
            border-radius: 8px;
        }
        .sanchuan-item span { display: block; }
        .sanchuan-name { font-weight: bold; color: #d35400; font-size: 0.9em; margin-bottom: 5px;}

        /* å››è¯¾ */
        .sike-box {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            text-align: center;
            gap: 8px;
        }
        .sike-col {
            background: #f0f8ff;
            padding: 10px 5px;
            border-radius: 6px;
            border: 1px solid #dceefc;
        }
        .sike-char { font-size: 1.1em; font-weight: bold; margin: 4px 0; }
        .sike-label { font-size: 0.75em; color: #888; margin-bottom: 5px; }

        /* å¤©åœ°ç›˜ä¹å®«æ ¼ */
        .tiandipan-box {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .grid-cell {
            aspect-ratio: 1;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 6px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .tian-pan { font-weight: bold; font-size: 1.3em; color: var(--primary-color); }
        .di-pan { font-size: 0.9em; color: #999; position: absolute; bottom: 5px; right: 5px; font-weight: bold;}
        .shen-jiang { font-size: 0.85em; color: #e74c3c; position: absolute; top: 5px; left: 5px;}

        .status-msg { text-align: center; margin-top: 10px; color: green; min-height: 20px; font-weight: bold;}
        
        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-msg { color: red; font-weight: bold; padding: 10px; background: #ffeaea; border-radius: 5px; display: none; text-align: center; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”® å¤§å…­å£¬æ™ºèƒ½æ’ç›˜ <small style="font-size:0.5em; color:#666">v2.0</small></h1>
    
    <div id="errorDisplay" class="error-msg"></div>

    <div class="controls">
        <input type="datetime-local" id="dateInput">
        <button onclick="calculatePan()">ğŸ“… å¼€å§‹æ’ç›˜</button>
        <button onclick="setNow()">â±ï¸ å½“å‰æ—¶é—´</button>
        <button class="secondary" onclick="copyForAI()">ğŸ¤– å¤åˆ¶ç»™ AI</button>
    </div>
    <div id="message" class="status-msg"></div>

    <div id="resultArea" style="display:none;">
        <div class="pan-section">
            <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
            <div class="info-grid" id="basicInfo"></div>
        </div>

        <div class="pan-section">
            <div class="section-title">ä¸‰ä¼ </div>
            <div class="sanchuan-box" id="sanChuan"></div>
        </div>

        <div class="pan-section">
            <div class="section-title">å››è¯¾</div>
            <div class="sike-box" id="siKe"></div>
        </div>

        <div class="pan-section">
            <div class="section-title">å¤©åœ°ç›˜ (åœ°æ”¯åäºŒå®«)</div>
            <div class="tiandipan-box" id="tianDiPan"></div>
        </div>
    </div>
</div>

<script>
    let currentLiuRen = null;
    let currentSolar = null;

    window.onload = function() {
        setNow();
        // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿åº“åŠ è½½å®Œæˆ
        setTimeout(calculatePan, 300);
    };

    function setNow() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
        document.getElementById('dateInput').value = localISOTime;
    }

    function showError(msg) {
        const errDiv = document.getElementById('errorDisplay');
        errDiv.style.display = 'block';
        errDiv.textContent = "é”™è¯¯ï¼š " + msg;
        console.error(msg);
    }

    function clearError() {
        document.getElementById('errorDisplay').style.display = 'none';
        document.getElementById('errorDisplay').textContent = '';
    }

    function calculatePan() {
        clearError();
        const inputVal = document.getElementById('dateInput').value;
        if (!inputVal) return alert("è¯·é€‰æ‹©æ—¶é—´");

        try {
            // 1. åˆ›å»º Date å¯¹è±¡
            const date = new Date(inputVal);
            if (isNaN(date.getTime())) throw new Error("æ— æ•ˆçš„æ—¥æœŸæ ¼å¼");

            // 2. åˆ›å»º Solar å¯¹è±¡ (å…¬å†)
            // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
            if (typeof Solar === 'undefined' || typeof LiuRen === 'undefined') {
                throw new Error("æ ¸å¿ƒç®—æ³•åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢");
            }

            currentSolar = Solar.fromDate(date);

            // 3. åˆ›å»ºå¤§å…­å£¬å¯¹è±¡
            // ğŸŒŸ ä¿®æ­£ç‚¹ï¼šä½¿ç”¨ fromSolar è€Œä¸æ˜¯ fromDateï¼Œæ›´ç¨³å¥
            currentLiuRen = LiuRen.fromSolar(currentSolar);

            // 4. æ¸²æŸ“ç•Œé¢
            renderUI();
            
            document.getElementById('resultArea').style.display = 'block';
            showMessage("æ’ç›˜æˆåŠŸï¼");

        } catch (e) {
            // ğŸŒŸ æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç¬¼ç»Ÿçš„æç¤º
            showError(e.message);
        }
    }

    function renderUI() {
        // è·å–å…³è”å¯¹è±¡
        const lunar = currentSolar.getLunar();
        const eightChar = lunar.getEightChar();

        // 1. æ¸²æŸ“åŸºç¡€ä¿¡æ¯
        document.getElementById('basicInfo').innerHTML = `
            <div><strong>å…¬å†ï¼š</strong>${currentSolar.toFullString()}</div>
            <div><strong>å†œå†ï¼š</strong>${lunar.toString()}</div>
            <div><strong>å››æŸ±ï¼š</strong>${eightChar.getYear()} ${eightChar.getMonth()} ${eightChar.getDay()} ${eightChar.getTime()}</div>
            <div><strong>èŠ‚æ°”ï¼š</strong>${lunar.getPrevJieQi().getName()} / ${lunar.getNextJieQi().getName()}</div>
            <div><strong>æœˆå°†ï¼š</strong>${currentLiuRen.getYueJiang()} (${currentLiuRen.getYueJiangShen()})</div>
            <div><strong>å æ—¶ï¼š</strong>${currentLiuRen.getShiZhi()}æ—¶</div>
            <div><strong>ç©ºäº¡ï¼š</strong>æ—¥(${lunar.getDayXunKong()}) æ—¶(${lunar.getTimeXunKong()})</div>
            <div><strong>æ ¼å±€ï¼š</strong>${currentLiuRen.getGeJu().join('ã€')}</div>
        `;

        // 2. æ¸²æŸ“ä¸‰ä¼ 
        const sanChuan = currentLiuRen.getSanChuan();
        const chuanNames = ['åˆä¼ ', 'ä¸­ä¼ ', 'æœ«ä¼ '];
        let scHtml = '';
        sanChuan.forEach((c, i) => {
            scHtml += `
                <div class="sanchuan-item">
                    <span class="sanchuan-name">${chuanNames[i]}</span>
                    <span style="font-size:1.5em; font-weight:bold; color:#333;">${c.getGan()}${c.getZhi()}</span>
                    <span style="color:#e74c3c; font-weight:bold;">${c.getJiang()}</span>
                    <span style="font-size:0.8em; color:#666;">(${c.getLu() ? 'ç¦„' : ''}${c.getMa() ? 'é©¬' : ''})</span>
                </div>
            `;
        });
        document.getElementById('sanChuan').innerHTML = scHtml;

        // 3. æ¸²æŸ“å››è¯¾
        // æ³¨æ„ï¼šlunaråº“è¿”å›çš„å››è¯¾é¡ºåºé€šå¸¸æ˜¯ [ç¬¬ä¸€è¯¾, ç¬¬äºŒè¯¾, ç¬¬ä¸‰è¯¾, ç¬¬å››è¯¾]
        // å¤æ³•æ’å¸ƒä¹ æƒ¯ï¼šä»å³å‘å·¦ã€‚è¿™é‡Œä¸ºäº†æ‰‹æœºé˜…è¯»ï¼Œæˆ‘ä»¬æŒ‰ 1 -> 4 æ’åˆ—ï¼Œå¹¶æ ‡æ˜èº«ä»½
        const siKe = currentLiuRen.getSiKe();
        const keLabels = ['ç¬¬ä¸€è¯¾(æ—¥é˜³)', 'ç¬¬äºŒè¯¾(æ—¥é˜´)', 'ç¬¬ä¸‰è¯¾(è¾°é˜³)', 'ç¬¬å››è¯¾(è¾°é˜´)'];
        let skHtml = '';
        siKe.forEach((k, i) => {
            skHtml += `
                <div class="sike-col">
                    <div class="sike-label">${keLabels[i]}</div>
                    <div class="sike-char" style="color:var(--primary-color)">${k.getTianPan()}</div>
                    <div class="sike-char">${k.getDiPan()}</div>
                </div>
            `;
        });
        document.getElementById('siKe').innerHTML = skHtml;

        // 4. æ¸²æŸ“å¤©åœ°ç›˜ (åœ°æ”¯åäºŒå®«)
        const diZhis = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
        let panHtml = '';
        
        diZhis.forEach(dz => {
            // ä¿®æ­£ç‚¹ï¼šç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ API è·å–è¯¥åœ°æ”¯ä¸Šçš„ä¿¡æ¯
            // getTianPan(dz): è·å–åœ°ç›˜ 'dz' ä¸Šä¹˜çš„å¤©ç›˜åœ°æ”¯
            // getTianJiang(dz): è·å–åœ°ç›˜ 'dz' ä¸Šä¹˜çš„å¤©å°†
            const tian = currentLiuRen.getTianPan(dz);
            const jiang = currentLiuRen.getTianJiang(dz);
            
            panHtml += `
                <div class="grid-cell">
                    <div class="shen-jiang">${jiang}</div>
                    <div class="tian-pan">${tian}</div>
                    <div class="di-pan">${dz}</div>
                </div>
            `;
        });
        document.getElementById('tianDiPan').innerHTML = panHtml;
    }

    function showMessage(msg) {
        const el = document.getElementById('message');
        el.textContent = msg;
        setTimeout(() => el.textContent = '', 3000);
    }

    function copyForAI() {
        if (!currentLiuRen) return alert("è¯·å…ˆæ’ç›˜");
        
        const lunar = currentSolar.getLunar();
        const eightChar = lunar.getEightChar();
        const sanChuan = currentLiuRen.getSanChuan();
        const siKe = currentLiuRen.getSiKe();

        // æ„é€ æç¤ºè¯
        let prompt = `æˆ‘æ­£åœ¨ä½¿ç”¨å¤§å…­å£¬æ’ç›˜åˆ†æé—®é¢˜ï¼Œè¯·ä½œä¸ºå¤§å…­å£¬ä¸“å®¶ï¼ˆå‚è€ƒå¤ç±å¦‚ã€Šæ¯•æ³•èµ‹ã€‹ï¼‰è¿›è¡Œè§£è¯»ã€‚

ã€æ’ç›˜æ•°æ®ã€‘
ğŸ“… å…¬å†ï¼š${currentSolar.toFullString()}
ğŸŒ™ å†œå†ï¼š${lunar.toString()}
ğŸ”¢ å¹²æ”¯ï¼š${eightChar.getYear()} ${eightChar.getMonth()} ${eightChar.getDay()} ${eightChar.getTime()}
ğŸŒŸ æœˆå°†ï¼š${currentLiuRen.getYueJiang()} (${currentLiuRen.getYueJiangShen()})  |  å æ—¶ï¼š${currentLiuRen.getShiZhi()}
ğŸš« ç©ºäº¡ï¼šæ—¥(${lunar.getDayXunKong()}) æ—¶(${lunar.getTimeXunKong()})
ğŸ§© æ ¼å±€ï¼š${currentLiuRen.getGeJu().join('ã€')}

ã€ä¸‰ä¼ ã€‘
1. åˆä¼ ï¼š${sanChuan[0].getGan()}${sanChuan[0].getZhi()} ä¸´ ${sanChuan[0].getJiang()}
2. ä¸­ä¼ ï¼š${sanChuan[1].getGan()}${sanChuan[1].getZhi()} ä¸´ ${sanChuan[1].getJiang()}
3. æœ«ä¼ ï¼š${sanChuan[2].getGan()}${sanChuan[2].getZhi()} ä¸´ ${sanChuan[2].getJiang()}

ã€å››è¯¾ã€‘(å¤©ç›˜/åœ°ç›˜)
1. ${siKe[0].getTianPan()}/${siKe[0].getDiPan()} (æ—¥é˜³)
2. ${siKe[1].getTianPan()}/${siKe[1].getDiPan()} (æ—¥é˜´)
3. ${siKe[2].getTianPan()}/${siKe[2].getDiPan()} (è¾°é˜³)
4. ${siKe[3].getTianPan()}/${siKe[3].getDiPan()} (è¾°é˜´)

ã€ä»»åŠ¡ã€‘
1. åˆ†ææ ¼å±€å‰å‡¶ã€‚
2. ä¾æ®â€œåˆä¼ çœ‹èµ·å› ï¼Œä¸­ä¼ çœ‹ç»è¿‡ï¼Œæœ«ä¼ çœ‹ç»“æœâ€çš„é€»è¾‘è¿›è¡Œæ¨æ¼”ã€‚
3. ç»“åˆç±»ç¥å’Œç¥å°†å…³ç³»ï¼Œç»™å‡ºå…·ä½“çš„å»ºè®®ã€‚`;

        navigator.clipboard.writeText(prompt).then(() => {
            showMessage("âœ… æç¤ºè¯å·²å¤åˆ¶ï¼è¯·ç²˜è´´ç»™ AIã€‚");
        }).catch(err => {
            console.error(err);
            alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
        });
    }
</script>

</body>
</html>
